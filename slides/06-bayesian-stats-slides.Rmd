---
title: "Bayesianische Statistik"
session: 7
subtitle: "Teil 6 <br/> Bayes Factors"
author: "Andrew Ellis"
# institute: "Kognitive Psychologie, Wahrnehmung und Methodenlehre, Universität Bern"
institute: "Methodenkurs Neurowissenschaft im Computerlab"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["css/xaringan-themer.css", "css/slides-style.css"]
    nature:
      highlightStyle: github #solarized-light # github
      highlightLines: true
      ratio: 16:10
      countIncrementalSlides: false
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
---

```{r child = "setup.Rmd"}
```

```{r load-packages, include=FALSE, warning=FALSE}
library(tidyverse)
library(rmarkdown)
library(kableExtra)
library(countdown)

theme_set(theme_grey(base_size = 14) +
            theme(panel.grid = element_blank()))
```



## Inhalt


1) Exkurs: Was ist eine Hypothese?

2) Schätzung von Bayes Factors.

  + Savage-Dickey Density Ratio
  + `bridge sampling` Package
  + `BayesFactor` Package
  + JASP: [jasp-stats.org/download](https://jasp-stats.org/download/)

---

class: middle

.pull-left-narrow[
  .huge-blue-number[1]
]
.pull-right-wide[
  .larger[
  Was ist eine Hypothese?
  ]
]

---


lorem ipsum


---


.discussion[
Wie würden Sie diese Daten analysieren?


- Die Daten sind messwiederholt. Für jede Person haben wir 3 Messungen.


- Welche Frage könnte hier interessant sein?
- Welche Methode(n) würden Sie hier anwenden?
- Bei Person 3 gibt einen _Ausreisser_. Was würden Sie tun?

]

```{r echo=FALSE}
countdown(minutes = 3)
```

---





class: middle

.pull-left-narrow[
  .huge-blue-number[2]
]
.pull-right-wide[
  .larger[
  Schätzung von Bayes Factors
  ]
]

---

Wir nehme als Beispiel einen simulierten Datensatz vom Package [bcogsci](https://github.com/bnicenboim/bcogsci). Falls Sie das Package nicht installieren können, können Sie einfach das File `df_contrasts1.rda` von hier [downloaden](https://github.com/bnicenboim/bcogsci/tree/master/data).

Wir haben eine abhängige Variable `DV` (Reaktionzeit) in 2 Gruppen, F1 ($\mu_1=0.8$ sec) und F2 ($\mu_2=0.4$ sec). Die Daten sind von 10 simulierten Vpn.

---


.panelset[
.panel[.panel-name[Daten laden]

```{r}
library(bcogsci)
data("df_contrasts1") 
df_contrasts1
```
]

.panel[.panel-name[Daten laden (alt)]

```{r include=TRUE, eval=FALSE}
df_contrasts1 <- load("data/df_contrasts1.rda")
df_contrasts1
```
]

.panel[.panel-name[Daten zusammenfassen]

```{r}
df_contrasts1_sum <- df_contrasts1 %>% 
  group_by(F) %>% 
  summarise(mean = mean(DV),
            se = sd(DV)/sqrt(n()))
df_contrasts1_sum
```

]

.panel[.panel-name[Plot]
```{r}
df_contrasts1_sum %>% 
  ggplot(aes(F, mean)) +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se),
                width = 0.2, size=1, color="blue") +
  geom_point(size = 4) +
  geom_line(aes(group = 1), linetype = 3)
```

]]


---

## Parameterschätzung

```{r}
fit1 <- brm(DV ~ 1 + F,
                 data = df_contrasts1,
                 family = gaussian(),
                 prior = prior(normal(0, 2), class = Intercept) +
                     prior(normal(0, 2), class = sigma) +
                     prior(normal(0, 1), class = b),
             cores = parallel::detectCores(),
             file = "models/BF_fit_F1", 
             file_refit = "on_change") 
```



---


```{r}
round(fixef(fit_F),3)
```


```{r}
mcmc_plot(fit_F)
```

---

## Savage-Dickey Density Ratio



```{r}
fit2 <- brm(DV ~ 1 + F,
                 data = df_contrasts1,
                 family = gaussian(),
                 prior = prior(normal(0, 2), class = Intercept) +
                     prior(normal(0, 2), class = sigma) +
                     prior(normal(0, 1), class = b),
             sample_prior = TRUE, #<<
             cores = parallel::detectCores(),
             file = "models/BF_fit_F2", 
             file_refit = "on_change") 
```



---

## Savage-Dickey Density Ratio

```{r}
fit2 %>% 
  mcmc_plot(c("b_FF2", "prior_b"))
```



---

## Savage-Dickey Density Ratio


```{r}
h1 <- fit2 %>% 
  hypothesis("FF2 = 0")
h1
```

---

## Savage-Dickey Density Ratio

```{r}
BF01 <- h1$hypothesis$Evid.Ratio
BF01
```
```{r}
BF10 <- 1/BF01
BF10
```




---


## Bridge sampling


```{r}
fit3 <- brm(DV ~ 1 + F,
                 data = df_contrasts1,
                 family = gaussian(),
                 prior = prior(normal(0, 2), class = Intercept) +
                     prior(normal(0, 2), class = sigma) +
                     prior(normal(0, 1), class = b),
             save_pars = save_pars(all = TRUE), #<<
             iter = 1e4, #<<
             cores = parallel::detectCores(),
             file = "models/BF_fit_F3", 
             file_refit = "on_change") 
```


---

## Bridge sampling

Nullmodell (Vergleichsmodell)

```{r}
fit4 <- brm(DV ~ 1,
                 data = df_contrasts1,
                 family = gaussian(),
                 prior = prior(normal(0, 2), class = Intercept) +
                     prior(normal(0, 2), class = sigma),
             save_pars = save_pars(all = TRUE), #<<
             iter = 1e4, #<<
             cores = parallel::detectCores(),
             file = "models/BF_fit_F4", 
             file_refit = "on_change") 
```



---

## Bridge sampling

```{r}
BF <- bayes_factor(fit3, fit4)
```
```{r}
BF
```


Bayes factor für Nullmodell: $BF_{01}$

```{r}
# Estimated Bayes factor in favor of fit4 over fit3
1/BF$bf
```


---

## BayesFactor Package

```{r message=FALSE, warning=FALSE}
library(BayesFactor)
bf = ttestBF(formula = DV ~ F, data = df_contrasts1)

bf
```


---

## JASP

```{r}
df_contrasts1 %>% 
  readr::write_csv(file = "data/df_contrasts1.csv")
```

